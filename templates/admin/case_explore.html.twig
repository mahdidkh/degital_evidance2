{% extends 'admin/layout.html.twig' %}

{% block title %}Explore:
	{{ casework.title }}
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<style>
		.explore-grid {
			display: grid;
			grid-template-columns: 1fr 380px;
			gap: 2rem;
		}

		.glass-panel {
			background: var(--card-bg);
			backdrop-filter: blur(16px);
			border: 1px solid var(--border-glass);
			border-radius: 28px;
			padding: 2rem;
			box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
		}

		.section-header {
			display: flex;
			align-items: center;
			gap: 0.75rem;
			margin-bottom: 2rem;
			padding-bottom: 1rem;
			border-bottom: 1px solid var(--border-glass);
		}

		.section-header h2 {
			font-size: 1.25rem;
			font-weight: 700;
			margin: 0;
			color: white;
		}

		/* Case Meta Cards */
		.case-meta-grid {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 1.5rem;
			margin-bottom: 2rem;
		}

		.meta-card {
			background: rgba(255, 255, 255, 0.03);
			border: 1px solid var(--border-glass);
			border-radius: 20px;
			padding: 1.25rem;
			display: flex;
			align-items: center;
			gap: 1rem;
		}

		.meta-icon {
			width: 48px;
			height: 48px;
			border-radius: 14px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.5rem;
		}

		.meta-info label {
			display: block;
			font-size: 0.75rem;
			color: var(--text-secondary);
			text-transform: uppercase;
			font-weight: 700;
			letter-spacing: 0.05em;
		}

		.meta-info span {
			font-weight: 700;
			color: white;
		}

		/* Evidence List */
		.evidence-list {
			display: flex;
			flex-direction: column;
			gap: 1rem;
		}

		.evidence-item {
			display: flex;
			align-items: flex-start;
			gap: 1.5rem;
			padding: 1.5rem;
			background: rgba(15, 23, 42, 0.4);
			border-radius: 20px;
			border: 1px solid var(--border-glass);
			transition: all 0.3s ease;
		}

		.evidence-item:hover {
			border-color: var(--accent-blue);
			transform: translateX(8px);
			background: rgba(59, 130, 246, 0.05);
		}

		.evidence-preview {
			width: 100px;
			height: 100px;
			border-radius: 12px;
			overflow: hidden;
			flex-shrink: 0;
			border: 1px solid var(--border-glass);
		}

		.evidence-preview img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		.evidence-icon {
			width: 100px;
			height: 100px;
			background: rgba(255, 255, 255, 0.05);
			border-radius: 12px;
			display: flex;
			align-items: center;
			justify-content: center;
			color: var(--text-secondary);
			flex-shrink: 0;
		}

		.evidence-details h3 {
			margin: 0;
			font-size: 1.1rem;
			color: white;
		}

		.evidence-details p {
			margin: 0.5rem 0;
			color: var(--text-secondary);
			font-size: 0.9rem;
			line-height: 1.6;
		}

		.hash-badge {
			display: inline-block;
			font-family: monospace;
			font-size: 0.75rem;
			color: var(--accent-blue);
			background: rgba(59, 130, 246, 0.1);
			padding: 4px 8px;
			border-radius: 6px;
			margin-top: 0.5rem;
		}

		/* Timeline */
		.timeline {
			position: relative;
			padding-left: 1.5rem;
		}

		.timeline::before {
			content: '';
			position: absolute;
			left: 0;
			top: 0;
			bottom: 0;
			width: 2px;
			background: var(--border-glass);
		}

		.timeline-entry {
			position: relative;
			padding-bottom: 2rem;
		}

		.timeline-entry::before {
			content: '';
			position: absolute;
			left: -1.85rem;
			top: 0.25rem;
			width: 12px;
			height: 12px;
			border-radius: 50%;
			background: var(--accent-purple);
			box-shadow: 0 0 10px var(--accent-purple);
		}

		.entry-date {
			font-size: 0.75rem;
			font-weight: 800;
			color: var(--accent-purple);
			text-transform: uppercase;
			margin-bottom: 0.25rem;
		}

		.entry-action {
			font-weight: 700;
			color: white;
			font-size: 0.9rem;
		}

		.entry-user {
			font-size: 0.8rem;
			color: var(--text-secondary);
			margin-top: 0.2rem;
		}

		.member-chip {
			display: inline-flex;
			align-items: center;
			gap: 0.5rem;
			background: rgba(255, 255, 255, 0.05);
			padding: 4px 10px;
			border-radius: 20px;
			font-size: 0.8rem;
			color: var(--text-secondary);
			border: 1px solid var(--border-glass);
		}
	</style>
{% endblock %}

{% block admin_content %}
	<header class="page-header">
		<div>
			<a href="{{ path('app_admin_cases') }}" style="color: var(--text-secondary); text-decoration: none; display: flex; align-items: center; gap: 0.5rem; font-weight: 600; margin-bottom: 0.5rem;">
				<span class="material-symbols-outlined">arrow_back</span>
				Back to Case Oversight
			</a>
			<h1 class="page-title">Case Exploration</h1>
			<p style="color: var(--text-secondary); font-weight: 500;">In-depth forensic audit for
				{{ casework.title }}</p>
		</div>
		<div style="background: rgba(255, 255, 255, 0.05); padding: 0.75rem 1.25rem; border-radius: 16px; border: 1px solid var(--border-glass); display: flex; align-items: center; gap: 1rem;">
			<span style="font-weight: 800; color: white;">#{{ casework.id }}</span>
			<div style="width: 1px; height: 20px; background: var(--border-glass);"></div>
			<span style="font-weight: 600; color: var(--accent-blue);">{{ casework.status|upper }}</span>
		</div>
	</header>

	<div class="case-meta-grid">
		<div class="meta-card">
			<div class="meta-icon" style="background: rgba(59, 130, 246, 0.1); color: var(--accent-blue);">
				<span class="material-symbols-outlined">groups</span>
			</div>
			<div class="meta-info">
				<label>Assigned Team</label>
				<span>{{ casework.assignedTeam ? casework.assignedTeam.name : 'Unassigned' }}</span>
			</div>
		</div>
		<div class="meta-card">
			<div class="meta-icon" style="background: rgba(139, 92, 246, 0.1); color: var(--accent-purple);">
				<span class="material-symbols-outlined">person</span>
			</div>
			<div class="meta-info">
				<label>Lead Supervisor</label>
				<span>{{ casework.createdBy ? casework.createdBy.firstName ~ ' ' ~ casework.createdBy.lastName : 'N/A' }}</span>
			</div>
		</div>
		<div class="meta-card">
			<div class="meta-icon" style="background: rgba(16, 185, 129, 0.1); color: var(--accent-emerald);">
				<span class="material-symbols-outlined">calendar_today</span>
			</div>
			<div class="meta-info">
				<label>Initiated On</label>
				<span>{{ casework.createdAt|date('M d, Y') }}</span>
			</div>
		</div>
	</div>

	<div class="explore-grid">
		<div class="glass-panel">
			<div class="section-header">
				<span class="material-symbols-outlined" style="color: var(--accent-blue);">inventory_2</span>
				<h2>Evidence Vault</h2>
			</div>

			<div class="evidence-list">
				{% for evidence in casework.evidences %}
					<div class="evidence-item">
						{% set isImage = false %}
						{% if evidence.storedFilename %}
							{% set ext = evidence.storedFilename|split('.')|last|lower %}
							{% if ext in ['jpg', 'jpeg', 'png', 'gif', 'webp'] %}
								{% set isImage = true %}
							{% endif %}
						{% endif %}

						{% if isImage %}
							<div class="evidence-preview">
								<img src="{{ asset('uploads/evidence/' ~ evidence.storedFilename) }}" alt="{{ evidence.title }}">
							</div>
						{% else %}
							<div class="evidence-icon">
								<span class="material-symbols-outlined" style="font-size: 2.5rem;">description</span>
							</div>
						{% endif %}

						<div class="evidence-details">
							<h3>{{ evidence.title }}</h3>
							<p>{{ evidence.description }}</p>

							<div style="display: flex; align-items: center; gap: 1rem; margin-top: 1rem;">
								<span class="member-chip">
									<span class="material-symbols-outlined" style="font-size: 0.9rem;">person</span>
									BY:
									{{ evidence.uploadedBy ? evidence.uploadedBy.email : 'Unknown' }}
								</span>
								<a href="{{ asset('uploads/evidence/' ~ evidence.storedFilename) }}" target="_blank" style="color: var(--accent-blue); font-size: 0.85rem; font-weight: 700; text-decoration: none; display: flex; align-items: center; gap: 0.25rem;">
									<span class="material-symbols-outlined" style="font-size: 1rem;">download</span>
									Download Archive
								</a>
							</div>

							<div class="hash-badge">
								SHA-256:
								{{ evidence.fileHash }}
							</div>
						</div>
					</div>
				{% else %}
					<div style="text-align: center; padding: 4rem; color: var(--text-secondary);">
						<span class="material-symbols-outlined" style="font-size: 3rem; opacity: 0.3;">folder_open</span>
						<p style="margin-top: 1rem;">No evidence objects recovered for this case yet.</p>
					</div>
				{% endfor %}
			</div>
		</div>

		<div class="glass-panel">
			<div class="section-header">
				<span class="material-symbols-outlined" style="color: var(--accent-purple);">route</span>
				<h2>Chain of Custody</h2>
			</div>

			<div class="timeline">
				{% set entries = [] %}
				{% for evidence in casework.evidences %}
					{% for entry in evidence.chainEntries %}
						{% set entries = entries|merge([entry]) %}
					{% endfor %}
				{% endfor %}

				{% for entry in entries|sort((a, b) => b.dateUpdate <=> a.dateUpdate) %}
					<div class="timeline-entry">
						<div class="entry-date">{{ entry.dateUpdate|date('M d, H:i') }}</div>
						<div class="entry-action">{{ entry.action }}</div>
						<div class="entry-user">{{ entry.user ? entry.user.email : 'System' }}</div>
						<div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem; font-style: italic;">
							{{ entry.description }}
						</div>
					</div>
				{% else %}
					<p style="text-align: center; color: var(--text-secondary); font-size: 0.9rem; padding: 2rem;">No custodial events recorded.</p>
				{% endfor %}
			</div>
		</div>
	</div>
{% endblock %}
