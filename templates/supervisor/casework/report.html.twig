{% extends 'base.html.twig' %}

{% block title %}Case Report #{{ casework.id }}
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<style>
		.report-container {
			max-width: 1000px;
			margin: 0 auto;
			padding: 2rem;
			background: white;
			color: #1e293b;
			font-family: 'Inter', sans-serif;
		}

		.report-header {
			border-bottom: 2px solid #0f172a;
			padding-bottom: 1rem;
			margin-bottom: 2rem;
			display: flex;
			justify-content: space-between;
			align-items: flex-end;
		}

		.report-title h1 {
			margin: 0;
			font-size: 2rem;
			color: #0f172a;
		}

		.report-meta {
			text-align: right;
			font-size: 0.9rem;
			color: #64748b;
		}

		.section {
			margin-bottom: 2.5rem;
		}

		.section-title {
			font-size: 1.25rem;
			font-weight: 700;
			color: #0f172a;
			border-bottom: 1px solid #e2e8f0;
			padding-bottom: 0.5rem;
			margin-bottom: 1rem;
		}

		.info-grid {
			display: grid;
			grid-template-columns: repeat(2, 1fr);
			gap: 1.5rem;
		}

		.info-item label {
			display: block;
			font-size: 0.8rem;
			color: #64748b;
			text-transform: uppercase;
			letter-spacing: 0.05em;
			margin-bottom: 0.25rem;
		}

		.info-item span {
			font-weight: 600;
			font-size: 1.1rem;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			font-size: 0.9rem;
		}

		th {
			text-align: left;
			padding: 0.75rem;
			background: #f8fafc;
			border-bottom: 2px solid #e2e8f0;
			font-weight: 600;
			color: #475569;
		}

		td {
			padding: 0.75rem;
			border-bottom: 1px solid #e2e8f0;
		}

		.status-badge {
			display: inline-block;
			padding: 0.25rem 0.5rem;
			border-radius: 4px;
			font-size: 0.8rem;
			font-weight: 600;
			text-transform: uppercase;
			border: 1px solid #cbd5e1;
		}

		@media print {
			body {
				background: white;
				color: black;
			}
			.no-print {
				display: none !important;
			}
			.report-container {
				padding: 0;
				box-shadow: none;
			}
			a {
				text-decoration: none;
				color: black;
			}
		}

		.btn-print {
			position: fixed;
			bottom: 2rem;
			right: 2rem;
			background: #0f172a;
			color: white;
			padding: 1rem 2rem;
			border-radius: 50px;
			border: none;
			font-weight: 600;
			cursor: pointer;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
			display: flex;
			align-items: center;
			gap: 0.5rem;
			transition: transform 0.2s;
		}

		.btn-print:hover {
			transform: translateY(-2px);
		}
	</style>
{% endblock %}

{% block body %}
	<div class="report-container">
		<header class="report-header">
			<div class="report-title">
				<h1>Forensic Case Report</h1>
				<div style="font-size: 1.2rem; margin-top: 0.5rem; color: #475569">Case #{{ casework.id }}:
					{{ casework.title }}</div>
			</div>
			<div class="report-meta">
				<div>Generated on:
					{{ generatedAt|date('M d, Y H:i:s') }}</div>
				<div>Generated by:
					{{ app.user.firstName }}
					{{ app.user.lastName }}</div>
			</div>
		</header>

		<section class="section">
			<h2 class="section-title">Case Overview</h2>
			<div class="info-grid">
				<div class="info-item">
					<label>Status</label>
					<span class="status-badge">{{ casework.status|upper }}</span>
				</div>
				<div class="info-item">
					<label>Priority</label>
					<span>{{ casework.priority|capitalize }}</span>
				</div>
				<div class="info-item">
					<label>Assigned Team</label>
					<span>{{ casework.assignedTeam ? casework.assignedTeam.name : 'Unassigned' }}</span>
				</div>
				<div class="info-item">
					<label>Investigators</label>
					<span>
						{% if casework.assignedTeam and casework.assignedTeam.investigateurs|length > 0 %}
							{{ casework.assignedTeam.investigateurs|length }}
							Members
						{% else %}
							0
						{% endif %}
					</span>
				</div>
			</div>
			<div class="info-item" style="margin-top: 1.5rem">
				<label>Description</label>
				<p style="margin: 0.5rem 0; line-height: 1.6">{{ casework.description }}</p>
			</div>
		</section>

		<section class="section">
			<h2 class="section-title">Evidence Inventory ({{ casework.evidences|length }}
				Items)</h2>
			{% if casework.evidences|length > 0 %}
				<table>
					<thead>
						<tr>
							<th style="width: 5%">ID</th>
							<th style="width: 40%">Evidence Details</th>
							<th style="width: 35%">File Object</th>
							<th style="width: 20%">Metadata</th>
						</tr>
					</thead>
					<tbody>
						{% for evidence in casework.evidences %}
							<tr>
								<td style="vertical-align: top;">#{{ evidence.id }}</td>
								<td style="vertical-align: top;">
									<div style="font-weight: 700; font-size: 1rem; margin-bottom: 0.5rem; color: #0f172a;">{{ evidence.title }}</div>
									<div style="margin-bottom: 0.5rem;">
										<span style="font-weight: 600; color: #64748b; font-size: 0.75rem; text-transform: uppercase;">Description:</span>
										<div style="white-space: pre-wrap; margin-top: 0.25rem;">{{ evidence.description }}</div>
									</div>
									{% if evidence.remarque %}
										<div style="background: #f8fafc; padding: 0.5rem; border-left: 3px solid #6366f1; margin-top: 0.5rem;">
											<span style="font-weight: 600; color: #6366f1; font-size: 0.75rem; text-transform: uppercase;">Remarque:</span>
											<div style="font-style: italic; margin-top: 0.25rem;">{{ evidence.remarque }}</div>
										</div>
									{% endif %}
								</td>
								<td style="vertical-align: top;">
									{% if evidence.storedFilename %}
										{% set ext = evidence.storedFilename|split('.')|last|lower %}
										{% set isImage = ext in ['jpg', 'jpeg', 'png', 'gif', 'webp'] %}

										{% if isImage %}
											<div style="width: 150px; height: 150px; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; margin-bottom: 0.5rem;">
												<img src="{{ asset('uploads/evidence/' ~ evidence.storedFilename) }}" style="width: 100%; height: 100%; object-fit: cover;" alt="Evidence Preview">
											</div>
										{% endif %}

										<div style="font-size: 0.8rem; margin-bottom: 0.25rem;">
											<strong>File:</strong>
											{{ evidence.storedFilename }}
										</div>
									{% endif %}
									<div style="font-size: 0.8rem;">
										<strong>Hash (SHA-256):</strong>
										<div style="font-family: monospace; background: #f1f5f9; padding: 0.25rem; border-radius: 4px; border: 1px solid #e2e8f0; word-break: break-all; margin-top: 0.25rem;">{{ evidence.fileHash }}</div>
									</div>
								</td>
								<td style="vertical-align: top;">
									<div style="font-size: 0.85rem;">
										<div style="margin-bottom: 0.5rem;">
											<strong>Date:</strong><br>
											{{ evidence.createdAt ? evidence.createdAt|date('M d, Y H:i') : 'N/A' }}
										</div>
										<div>
											<strong>Uploaded By:</strong><br>
											{{ evidence.uploadedBy ? evidence.uploadedBy.email : 'Unknown' }}
										</div>
									</div>
								</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
			{% else %}
				<p style="color: #64748b; font-style: italic;">No evidence recorded for this case.</p>
			{% endif %}
		</section>

		<section class="section">
			<h2 class="section-title">Chain of Custody Timeline</h2>
			{% set entries = [] %}
			{% for evidence in casework.evidences %}
				{% for entry in evidence.chainEntries %}
					{% set entries = entries|merge([entry]) %}
				{% endfor %}
			{% endfor %}

			{% if entries|length > 0 %}
				<table>
					<thead>
						<tr>
							<th>Date/Time</th>
							<th>Action</th>
							<th>User</th>
							<th>Evidence</th>
							<th>Details</th>
						</tr>
					</thead>
					<tbody>
						{% for entry in entries|sort((a, b) => b.dateUpdate <=> a.dateUpdate) %}
							<tr>
								<td>{{ entry.dateUpdate|date('Y-m-d H:i') }}</td>
								<td>
									<strong>{{ entry.action }}</strong>
								</td>
								<td>{{ entry.user ? entry.user.email : 'System' }}</td>
								<td>{{ entry.evidence.title }}</td>
								<td>{{ entry.description }}</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
			{% else %}
				<p style="color: #64748b; font-style: italic;">No history entries found.</p>
			{% endif %}
		</section>

		<div style="margin-top: 4rem; border-top: 1px solid #e2e8f0; padding-top: 1rem; font-size: 0.8rem; text-align: center; color: #94a3b8;">
			CONFIDENTIAL DOCUMENT - FOR OFFICIAL USE ONLY
		</div>
	</div>

	<button onclick="window.print()" class="btn-print no-print">
		<span class="material-symbols-outlined">print</span>
		Print Report
	</button>
{% endblock %}
