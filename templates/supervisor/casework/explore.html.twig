{% extends 'base.html.twig' %}

{% block title %}Explore Case:
	{{ casework.title }}
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<style>:root
	{
		--bg-dark: #0f172a;
		--card-bg: rgba(30, 41, 59, 0.6);
		--text-primary: #f8fafc;
		--text-secondary: #94a3b8;
		--accent-blue: #3b82f6;
		--accent-purple: #8b5cf6;
		--sidebar-width: 280px;
		--border-glass: rgba(255, 255, 255, 0.1);
	}

	body {
		background: radial-gradient(circle at top right, #1e293b, #0f172a);
		color: var(--text-primary);
		font-family: 'Inter', system-ui, sans-serif;
		margin: 0;
	}

	.explore-container {
		margin-left: var(--sidebar-width);
		padding: 3rem;
		min-height: 100vh;
	}

	.nav-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 3rem;
	}

	.btn-back {
		color: var(--text-secondary);
		text-decoration: none;
		display: flex;
		align-items: center;
		gap: 0.5rem;
		font-weight: 500;
		transition: color 0.2s;
	}

	.btn-back:hover {
		color: white;
	}

	.page-title {
		font-size: 2.5rem;
		font-weight: 800;
		background: linear-gradient(to right, #3b82f6, #8b5cf6);
		-webkit-background-clip: text;
		-webkit-text-fill-color: transparent;
	}

	.dashboard-grid {
		display: grid;
		grid-template-columns: 1fr 350px;
		gap: 2rem;
	}

	.glass-panel {
		background: var(--card-bg);
		backdrop-filter: blur(12px);
		border: 1px solid var(--border-glass);
		border-radius: 24px;
		padding: 2rem;
		box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
	}

	.section-header {
		display: flex;
		align-items: center;
		gap: 0.75rem;
		margin-bottom: 2rem;
		padding-bottom: 1rem;
		border-bottom: 1px solid var(--border-glass);
	}

	.section-header h2 {
		font-size: 1.25rem;
		font-weight: 700;
		margin: 0;
	}

	/* Evidence List Styles */
	.evidence-list {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}

	.evidence-item {
		display: flex;
		align-items: center;
		gap: 1.5rem;
		padding: 1.25rem;
		background: rgba(15, 23, 42, 0.4);
		border-radius: 16px;
		border: 1px solid var(--border-glass);
		transition: all 0.3s ease;
	}

	.evidence-item:hover {
		transform: translateX(10px);
		border-color: var(--accent-blue);
		background: rgba(59, 130, 246, 0.1);
	}

	.evidence-preview {
		width: 120px;
		height: 120px;
		border-radius: 12px;
		overflow: hidden;
		flex-shrink: 0;
		border: 1px solid var(--border-glass);
		background: rgba(15, 23, 42, 0.4);
		transition: transform 0.3s ease;
	}

	.evidence-item:hover .evidence-preview {
		transform: scale(1.05);
		border-color: var(--accent-blue);
	}

	.evidence-preview img {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}

	.evidence-icon {
		width: 120px;
		height: 120px;
		background: rgba(59, 130, 246, 0.1);
		border-radius: 12px;
		display: flex;
		align-items: center;
		justify-content: center;
		color: var(--accent-blue);
		flex-shrink: 0;
	}

	.evidence-info h3 {
		margin: 0;
		font-size: 1rem;
		color: white;
	}

	.evidence-info p {
		margin: 0.25rem 0;
		font-size: 0.85rem;
		color: var(--text-secondary);
		line-height: 1.5;
	}

	.evidence-footer {
		margin-top: 1rem;
		display: flex;
		gap: 1rem;
		align-items: center;
	}

	.btn-download {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		padding: 0.4rem 1rem;
		background: rgba(16, 185, 129, 0.1);
		border: 1px solid rgba(16, 185, 129, 0.3);
		border-radius: 8px;
		color: #10b981;
		font-size: 0.75rem;
		font-weight: 600;
		text-decoration: none;
		transition: all 0.2s;
	}

	.btn-download:hover {
		background: rgba(16, 185, 129, 0.2);
		transform: translateY(-1px);
	}

	.remarque-box {
		margin-top: 0.75rem;
		padding: 0.75rem;
		background: rgba(255, 255, 255, 0.03);
		border-left: 3px solid var(--accent-purple);
		border-radius: 4px;
		font-style: italic;
		font-size: 0.85rem;
	}

	/* Timeline Styles */
	.timeline {
		position: relative;
		padding-left: 2rem;
	}

	.timeline::before {
		content: '';
		position: absolute;
		left: 0;
		top: 0;
		bottom: 0;
		width: 2px;
		background: var(--border-glass);
	}

	.timeline-event {
		position: relative;
		margin-bottom: 2rem;
	}

	.timeline-event::before {
		content: '';
		position: absolute;
		left: -2.35rem;
		top: 0.25rem;
		width: 12px;
		height: 12px;
		background: var(--accent-purple);
		border-radius: 50%;
		box-shadow: 0 0 10px var(--accent-purple);
	}

	.event-time {
		font-size: 0.75rem;
		font-weight: 700;
		color: var(--accent-purple);
		text-transform: uppercase;
		margin-bottom: 0.25rem;
	}

	.event-action {
		font-weight: 600;
		color: white;
		font-size: 0.9rem;
	}

	.event-user {
		font-size: 0.8rem;
		color: var(--accent-blue);
		font-weight: 500;
		margin-top: 0.1rem;
	}

	.event-desc {
		font-size: 0.8rem;
		color: var(--text-secondary);
		margin-top: 0.25rem;
	}

	.uploader-tag {
		font-size: 0.75rem;
		color: var(--accent-blue);
		opacity: 0.8;
		display: flex;
		align-items: center;
		gap: 0.4rem;
		margin-top: 0.5rem;
		font-weight: 500;
	}

	.empty-state {
		text-align: center;
		padding: 3rem;
		color: var(--text-secondary);
	}

	.empty-state p {
		color: var(--text-secondary);
		margin-top: 1rem;
	}

	.readonly-banner {
		grid-column: 1 / -1;
		background: rgba(245, 158, 11, 0.1);
		border: 1px solid rgba(245, 158, 11, 0.3);
		border-radius: 12px;
		padding: 0.75rem 1.5rem;
		color: #f59e0b;
		display: flex;
		align-items: center;
		gap: 0.75rem;
		margin-bottom: 1.5rem;
		font-weight: 600;
		font-size: 0.9rem;
	}

	.btn-verify {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		padding: 0.4rem 1rem;
		background: rgba(59, 130, 246, 0.1);
		border: 1px solid rgba(59, 130, 246, 0.3);
		border-radius: 8px;
		color: var(--accent-blue);
		font-size: 0.75rem;
		font-weight: 600;
		cursor: pointer;
		transition: all 0.2s;
	}

	.btn-verify:hover {
		background: rgba(59, 130, 246, 0.2);
		transform: translateY(-1px);
	}

	.btn-verify.loading {
		opacity: 0.7;
		pointer-events: none;
	}

	.integrity-status {
		font-size: 0.75rem;
		display: flex;
		align-items: center;
		gap: 0.25rem;
		font-weight: 600;
	}

	.status-verified {
		color: #10b981;
	}
	.status-tampered {
		color: #ef4444;
	}
	.status-error {
		color: #f59e0b;
	}

	@keyframes spin {
		from {
			transform: rotate(0deg);
		}
		to {
			transform: rotate(360deg);
		}
	}

	.spin {
		animation: spin 1s linear infinite;
	}
</style>{% endblock %}{% block body %}
{% include 'componant/sidebar_supervisor.html.twig' %}

<div class="explore-container">
	<header class="nav-header">
		<div>
			<a href="{{ path('app_supervisor_casework_show', {id: casework.id}) }}" class="btn-back">
				<span class="material-symbols-outlined">arrow_back</span>
				Back to Case Details
			</a>
			<h1 class="page-title">Explore Case Oversight</h1>
		</div>
		<div style="display: flex; gap: 1rem; align-items: center;">
			<a href="{{ path('app_supervisor_casework_report', {id: casework.id}) }}" target="_blank" class="btn-download" style="background: rgba(59, 130, 246, 0.2); border-color: var(--accent-blue); color: var(--accent-blue); font-size: 0.9rem; padding: 0.6rem 1.2rem;">
				<span class="material-symbols-outlined">description</span>
				Generate Report
			</a>
			<div class="case-id">#{{ casework.id }}</div>
		</div>
	</header>

	{% if casework.status != 'open' %}
		<div class="readonly-banner">
			<span class="material-symbols-outlined">lock</span>
			READ-ONLY MODE: This case is
			{{ casework.status|upper }}. No new evidence or modifications are permitted.
		</div>
	{% endif %}

	<div
		class="dashboard-grid">
		<!-- Main Content: Evidence -->
		<div class="glass-panel">
			<div class="section-header">
				<span class="material-symbols-outlined" style="color: var(--accent-blue)">fingerprint</span>
				<h2>Dossier Evidence</h2>
			</div>

			<div class="evidence-list">
				{% for evidence in casework.evidences %}
					<div class="evidence-item">
						{% set isImage = false %}
						{% if evidence.storedFilename %}
							{% set ext = evidence.storedFilename|split('.')|last|lower %}
							{% if ext in ['jpg', 'jpeg', 'png', 'gif', 'webp'] %}
								{% set isImage = true %}
							{% endif %}
						{% endif %}

						{% if isImage %}
							<div class="evidence-preview">
								<img src="{{ asset('uploads/evidence/' ~ evidence.storedFilename) }}" alt="{{ evidence.title }}">
							</div>
						{% else %}
							<div class="evidence-icon">
								<span class="material-symbols-outlined" style="font-size: 2.5rem;">description</span>
							</div>
						{% endif %}

						<div class="evidence-info" style="flex: 1;">
							<h3>{{ evidence.title }}</h3>
							<p>{{ evidence.description }}</p>

							{% if evidence.uploadedBy %}
								<div class="uploader-tag">
									<span class="material-symbols-outlined" style="font-size: 0.9rem;">upload_file</span>
									Uploaded by:
									{{ evidence.uploadedBy.email }}
								</div>
							{% endif %}

							{% if evidence.remarque %}
								<div class="remarque-box">
									<strong>Remarque:</strong>
									{{ evidence.remarque }}
								</div>
							{% endif %}

							<div class="evidence-footer">
								<p style="font-family: monospace; font-size: 0.75rem; color: var(--text-dim);">
									Hash:
									{{ evidence.fileHash }}
								</p>

								{% if evidence.storedFilename %}
									<a href="{{ asset('uploads/evidence/' ~ evidence.storedFilename) }}" class="btn-download" target="_blank">
										<span class="material-symbols-outlined" style="font-size: 1rem;">download</span>
										Download
									</a>

									<button class="btn-verify" onclick="verifyIntegrity({{ evidence.id }}, this)">
										<span class="material-symbols-outlined" style="font-size: 1rem;">verified_user</span>
										Verify Integrity
									</button>
								{% endif %}
							</div>
						</div>
					</div>
				{% else %}
					<div class="empty-state">
						<span class="material-symbols-outlined" style="font-size: 3rem; opacity: 0.5">folder_off</span>
						<p>No evidence found for this case.</p>
					</div>
				{% endfor %}
			</div>
		</div>

		<!-- Sidebar: Timeline -->
		<div class="glass-panel">
			<div class="section-header">
				<span class="material-symbols-outlined" style="color: var(--accent-purple)">history</span>
				<h2>Chain of Custody Timeline</h2>
			</div>

			<div class="timeline">
				{% set entries = [] %}
				{% for evidence in casework.evidences %}
					{% for entry in evidence.chainEntries %}
						{% set entries = entries|merge([entry]) %}
					{% endfor %}
				{% endfor %}

				{% for entry in entries|sort((a, b) => b.dateUpdate <=> a.dateUpdate) %}
					<div class="timeline-event">
						<div class="event-time">{{ entry.dateUpdate|date('M d, Y') }}</div>
						<div class="event-action">{{ entry.action }}</div>
						{% if entry.user %}
							<div class="event-user">
								<span class="material-symbols-outlined" style="font-size: 0.9rem; vertical-align: middle;">person</span>
								{{ entry.user.email }}
							</div>
						{% endif %}
						<div class="event-desc">{{ entry.description }}</div>
					</div>
				{% else %}
					<div class="empty-state">
						<p>No history records</p>
					</div>
				{% endfor %}
			</div>
		</div>
	</div>
</div>{% endblock %}{% block javascripts %}
{{ parent() }}
<script>
	async function verifyIntegrity(evidenceId, btn) {
const originalContent = btn.innerHTML;
btn.classList.add('loading');
btn.innerHTML = '<span class="material-symbols-outlined spin" style="font-size: 1rem;">sync</span> Verifying...';

try {
const response = await fetch (`/supervisor/evidence/${evidenceId}/verify`, {
method: 'POST',
headers: {
'X-Requested-With': 'XMLHttpRequest'
}
});

const data = await response.json();
const footer = btn.closest('.evidence-footer');

// Remove existing status if any
const existingstatus = footer.querySelector('.integrity-status');
if (existingstatus) 
existingstatus.remove();



const statusEl = document.createElement('div');
statusEl.className = `integrity-status status-${
data.status
}`;

if (data.status === 'verified') {
statusEl.innerHTML = '<span class="material-symbols-outlined" style="font-size: 1rem;">check_circle</span> Verified';
btn.style.borderColor = '#10b981';
btn.style.color = '#10b981';
} else if (data.status === 'tampered') {
statusEl.innerHTML = '<span class="material-symbols-outlined" style="font-size: 1rem;">warning</span> TAMPERED';
btn.style.borderColor = '#ef4444';
btn.style.color = '#ef4444';
} else {
statusEl.innerHTML = '<span class="material-symbols-outlined" style="font-size: 1rem;">error</span> ' + (
data.message || 'Error'
);
} footer.appendChild(statusEl);

// Refresh the timeline after a short delay so the user can see the new log entry
setTimeout(() => {
window.location.reload();
}, 1500);
} catch (error) {
console.error('Error verifying integrity:', error);
} finally {
btn.classList.remove('loading');
btn.innerHTML = originalContent;
}
}
</script>{% endblock %}
